<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <title>Musreact - mustache to react compiler</title>
  <link rel="stylesheet" href="codemirror/lib/codemirror.css">
  <script src="codemirror/lib/codemirror.js"></script>
  <script src="codemirror/mode/xml/xml.js"></script>
  <script src="codemirror/mode/javascript/javascript.js"></script>
  <script src="js/react.js"></script>
  <script src="js/musreact.js"></script>
<style>
#code {
    width: 48%;
    float: left;
}
#result {
  width: 48%;
  float: right;
}

pre {
  background-color: #fee;
}
</style>
</head>

<body>
<pre id="errors"></pre>

<div id="code">
<div id="template">
  <label>Type the text of your mureact template here:</label>
  <textarea>
<div>
<h1>{{name}} loves musreact </h1>
<p>
  List of technologies that allow to build UIs:
    <ul>
      {{# people}}
        <li>{{name}}</li>
      {{/people}}
      {{^ people}}
        <em>No one</em>
      {{/ people}}
    </ul>
</p>
<p>
  <label>Type text here, and update the data. It doesn't disappear<br/>
    {{#input}}
      <input type={{type}} onChange={{onChange}} />
    {{/input}}
  </label>
</p>
</div>
</textarea>
</div>

<div id="data">
  <label>type your data here</label>
  <textarea>
{
  "name": "Ophir",
  "people" : [
    {"name":"Yoan"},
    {"name":"Elise", "age":12}
  ],
  "input" : {
    "type": "email",
    "onChange": function(e){
      console.log(e.target.value);
    }
  }
}
</textarea>
</div>
</div>

<div id="result">
  result here
</div>


<script>
var tpl = CodeMirror.fromTextArea(document.querySelector("#template>textarea"), {
    lineNumbers: true,
    mode: "xml"
});
tpl.on("change", compile);

var data = CodeMirror.fromTextArea(document.querySelector("#data>textarea"), {
    lineNumbers: true,
    mode: "javascript"
});
data.on("change", parsedata);

function error(txt) {
  document.querySelector("#errors").textContent = txt;
}

var reactComp;
function compile() {
  error("");
  try {
     var src = parser.parse(tpl.getValue().trim());
  } catch (e) {
    error(e);
    throw e;
  }
  try {
    reactComp = eval(src);
  } catch (e) {
    error("The source generated by musreact is not valid. This is a BUG."+
        " Please report it on github.\n" +
        "generated code: " + src + "\n\n\n"+
        "error: "+e); 
    throw e;
  }
  run();
}

var jsondata = {};
function parsedata() {
  error("");
  try {
    eval("jsondata = " + data.getValue());
  } catch(e) {
    error(e);
  }
  run();
}

function run() {
  try {
    React.render(
        React.createElement(reactComp, jsondata),
        document.getElementById("result")
    );
  } catch(e) {
    error("failed to render.\n\n"+e);
    throw e;
  }
}

compile();
parsedata();
compile();
</script>
</body>
</html>
